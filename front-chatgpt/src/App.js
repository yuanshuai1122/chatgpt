import React, {useEffect, useState, useRef} from 'react';
import {Button, Input, Layout, theme, message as messageAntd, Modal, Upload, Select, Empty} from 'antd';
import {PlusOutlined, LoadingOutlined, UploadOutlined} from '@ant-design/icons';
import Message from "./components/message";

const {TextArea} = Input;
const {Content, Footer, Sider} = Layout;
const messageType = {
  assistant: "assistant",
  user: "user"
};
const App = () => {
  const {
    token: {colorBgContainer},
  } = theme.useToken();

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isModalOpenKey, setIsModalOpenKey] = useState(false);
  const chatWrapperRef = useRef();
  const [onRequest, setOnRequest] = useState(false);
  const [question, setQuestion] = useState("");
  const [messages, setMessages] = useState([]);
  const [chatKey, setChatKey] = useState(window.localStorage.getItem('key'))
  const [model, setModel] = useState()
  const [signKey, setSignKey] = useState('')
  const [newKey, setNewKey] = useState('')
  const [keyLoading, setKeyLoading] = useState(false)
  const [streamHosts, setStreamHosts] = useState([
    '//api-chatgpt.yuanshuai.vip',
    '//apiv2-chatgpt.yuanshuai.vip'
  ])

  /**
   * Ëé∑ÂèñÈöèÊú∫Êé®ÊµÅhosts
   */
  const getRandomStreamHost = ()=> {
    // ÁîüÊàê‰∏Ä‰∏™ÈöèÊú∫Á¥¢Âºï
    const randomIndex = Math.floor(Math.random() * streamHosts.length);
    // Ëé∑ÂèñÈöèÊú∫ÂÖÉÁ¥†
    return streamHosts[randomIndex];
  };

  const showModal = () => {
    setIsModalOpen(true);
  };

  const handleOk = () => {
    setIsModalOpen(false);
  };

  const handleCancel = () => {
    setIsModalOpen(false);
  };

  const showModalKey = () => {
    setIsModalOpenKey(true);
  };

  const handleOkKey = () => {
    setChatKey(newKey)
    window.localStorage.setItem('key', newKey)
    setIsModalOpenKey(false);
  };

  const handleCancelKey = () => {
    setIsModalOpenKey(false);
  };

  const getAnswer = async () => {
    if (!chatKey) {
      messageAntd.error('‰ΩøÁî®Êú¨Á´ôËØ∑ÂÖàËé∑ÂèñKEY')
      return
    }
    if (!question) {
      messageAntd.error('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ')
      return
    }
    if (onRequest) return;
    const newMessages = [...messages, {
      role: messageType.user,
      content: question
    }];
    setMessages(newMessages);
    // ËÆæÁΩÆÊú¨Âú∞ÁºìÂ≠ò
    window.localStorage.setItem("messages", JSON.stringify(newMessages))
    setQuestion("");
    setOnRequest(true);
    let mesStr = ''
    fetch('//chatgpt.yuanshuai.vip/api/chat/sign', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json;charset=UTF-8'
      },
      body: JSON.stringify({
        prompt: newMessages.slice(-3),
        chatKey,
        model
      })
    })
      .then(res => res.json())
      .then(res => {
        console.log(res);
        if (res.code !== 200) {
          setOnRequest(false);
          messageAntd.warning(res.msg)
          if (res.code === 302) {
            showModalKey()
          }
          return;
        }
        setSignKey(res.data)
        try {
          const newMessages1 = [...newMessages, {
            role: messageType.assistant,
            content: ''
            }
          ];

          // Ëé∑ÂèñÈöèÊú∫Êé®ÊµÅurl
          const randomStreamHost = getRandomStreamHost();
          const envSource = new EventSource(`${randomStreamHost}/api/chatgpt/stream?signKey=${res.data}`)
          console.log(envSource);
          envSource.addEventListener('error', function(event) {
            messageAntd.warning('ÊúçÂä°Ê≥¢Âä®ÔºåËØ∑ÈáçËØïÔºÅ')
            setOnRequest(false);
            envSource.close()
          });
          envSource.addEventListener('message', (e) => {
            const data = JSON.parse(e.data)
            if (data.content === null) {
              setOnRequest(false);
              envSource.close()
              return
            }
            mesStr += data.content
            newMessages1.forEach((ele, index) => {
              if (index === newMessages1.length - 1) {
                ele.content = mesStr
              }
            })
            setMessages([...newMessages1]);
            window.localStorage.setItem("messages", JSON.stringify([...newMessages1]))
          })
        } catch (e) {
          console.log(e);
        }

      })
  };

  /**
   * Â§ÑÁêÜ‰∏ãÊãâÈÄâÊã©
   * @param value
   */
  const handleChange = (value) => {
    console.log(`selected ${value}`);
    setModel(value)
  };

  useEffect(() => {
    // ÂõûÊòæÁ§∫ÂéÜÂè≤ÂØπËØù
    const reMes = window.localStorage.getItem('messages')
    if (reMes) {
      setMessages(JSON.parse(reMes))
    }
    // ÁõëÂê¨myDivÂÖÉÁ¥†ÁöÑÂ≠êÂÖÉÁ¥†ÂèòÂåñ
    const observer = new MutationObserver(() => {
      // ÂΩìmyDivÂÖÉÁ¥†ÁöÑÈ´òÂ∫¶Â¢ûÂä†ÂêéÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
      chatWrapperRef.current.scrollTop = chatWrapperRef.current.scrollHeight;
    });
    observer.observe(chatWrapperRef.current, {childList: true, subtree: true});
    return () => {
      observer.disconnect();
    };
  }, []);

  const getKey = () => {
    if (window.localStorage.getItem('key')) {
      return
    }
    setKeyLoading(true)
    fetch('//chatgpt.yuanshuai.vip/api/key/create', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json;charset=UTF-8'
      }
    })
      .then(res => res.json())
      .then(res => {
        console.log(res);
        if (res.code === 200) {
          messageAntd.success('Ëé∑ÂèñÊàêÂäü')
          setChatKey(res.data)
          window.localStorage.setItem('key', res.data)
          setKeyLoading(false)
        }
      })
  }

  const sedMessage = async (event) => {
    if (event.keyCode === 13 && event.code === "Enter") {
      getAnswer()
    }
  }

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text)
      .then(() => {
        messageAntd.info('ÊñáÊú¨Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
      })
      .catch(() => {
        console.error('Êó†Ê≥ïÂ§çÂà∂ÊñáÊú¨Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
      });
  }


  return (
    <div>
      <Layout
        style={{
          overflow: 'auto',
          height: `calc(100vh - var(--browser-address-bar, 0px)`,
        }}
      >
        <Sider
          breakpoint="lg"
          collapsedWidth="0"
          onBreakpoint={(broken) => {
            console.log(broken);
          }}
          onCollapse={(collapsed, type) => {
            console.log(collapsed, type);
          }}
        >
          <div
            className='newPair'
          >
            <div>
              <Button
                block
                onClick={() => {
                  setSignKey('')
                  setMessages([])
                  window.localStorage.setItem("messages", "")
                }}
              >
                <PlusOutlined/>
                ÂºÄÂßãÊñ∞ÂØπËØù
              </Button>
            </div>
            <div className='getkey'>
              <Button loading={keyLoading} onClick={() => {
                if (chatKey) {
                  copyToClipboard(chatKey)
                  messageAntd.info(chatKey)
                  return
                }
                getKey()
              }} block>{chatKey ? 'Êü•Áúã | Â§çÂà∂KEY' : 'Ëé∑ÂèñKEY'}</Button>
            </div>
            <div className='getkey'>
              <Button
                block
                onClick={() => {
                  window.localStorage.removeItem('key')
                  setChatKey('')
                }}
              >
                Ê∏ÖÈô§KEY
              </Button>
            </div>
          </div>
        </Sider>
        <Layout>
          <Content style={{margin: '10px 10px 0'}}>
            <div style={{padding: 10, height: '100%', background: colorBgContainer}}>
              <div ref={chatWrapperRef} className='message_box'>
                  {window.localStorage.getItem('messages') === ""
                      ?
                      <Empty style={{marginTop: 50}}
                        image="/dog.gif"
                        imageStyle={{
                            height: 150,
                        }}
                        description={
                            <span>
                              ‰∏ç‰ºöÂ∞±ÈóÆÂêßÔºüüòÅ
                            </span>
                                                                    }
                      >
                      </Empty>
                          :
                          null
                  }
                {
                  messages.map((ele, index) => {
                    return <div key={index}>
                      {
                        ele.role !== 'assistant'
                          ?
                          <div className="bubble right">
                            <a className="avatar"><img
                              src="/ddog.jpeg"
                            />
                            </a>
                            <div className="wrap">
                              <div style={{
                                maxWidth: `calc(100% - 5px)`
                              }} className="content">
                                <Message content={ele.content}/>
                              </div>
                            </div>
                          </div>
                          :
                          <div className="bubble left">
                            <a className="avatar"><img
                              src="/fat.jpg"
                            /></a>
                            <div className="wrap">
                              <div style={{
                                maxWidth: `calc(100% - 5px)`

                              }} className="content">
                                {
                                  ele.content
                                    ?
                                    <Message content={ele.content}/>
                                    :
                                    <LoadingOutlined style={{color: 'rgba(0,0,0,.45)'}}/>
                                }

                              </div>
                            </div>
                          </div>
                      }
                    </div>
                  })
                }
              </div>
              <div className='message_input'>
                <Select
                    defaultValue="gpt-3.5"
                    style={{
                      width: 100,
                    }}
                    onChange={handleChange}
                    options={[
                      {
                        value: 'gpt-3.5',
                        label: 'gpt-3.5',
                      },
                      {
                        value: 'gpt-4',
                        label: 'gpt-4',
                      },
                    ]}
                />
                <div className='message_input_text'>

                  <TextArea
                    onKeyDown={(e) => {
                      sedMessage(e)
                    }}
                    placeholder='ÂèëÈÄÅÊ∂àÊÅØÁªôAI'
                    style={{
                      width: '100%'
                    }}
                    disabled={onRequest}
                    value={question}
                    onChange={(e) => setQuestion(e.target.value)}
                    autoSize={{minRows: 2, maxRows: 2}}
                  />
                </div>
                <div className='message_input_send'>
                  <Button
                    onClick={() => {
                      getAnswer()
                    }}
                  >
                    {
                      onRequest ? <LoadingOutlined/>
                        : 'ÂèëÈÄÅ'
                    }
                  </Button>
                </div>
                <div className='message_input_key'>
                  <img onClick={() => {
                    setIsModalOpenKey(true);
                  }} src="/7hrqaokPWn.png" alt=""/>
                </div>

              </div>
            </div>
          </Content>
          <Footer
            style={{
              textAlign: 'center',
              padding: 10,
              fontSize: 10,
              cursor: "pointer"
            }}
            onClick={() => {
              showModal()
            }}
          >
            Êú¨Á´ôÁÇπÔºå‰ªÖ‰æõÂ≠¶‰π† AI ‰ΩøÁî®Ôºå‰ΩøÁî®ÂâçËØ∑Áü•Êôì ÂÖçË¥£Áî≥Êòé
          </Footer>
        </Layout>
      </Layout>

      <Modal title="Â£∞Êòé" open={isModalOpen} onOk={handleOk} onCancel={handleCancel}>
        Êú¨ÁΩëÁ´ô ‰ªÖÊòØ‰∏ÄÊ¨æËôöÊãüËÅäÂ§©Êú∫Âô®‰∫∫ÔºåÂÖ∂Êèê‰æõÁöÑ‰ø°ÊÅØÂíåÂª∫ËÆÆ‰ªÖ‰æõÂèÇËÄÉÔºå‰∏ç‰ª£Ë°®ÂÖ∑ÊúâÊ≥ïÂæãÊàñ‰∏ì‰∏öÁöÑÊÄßË¥®„ÄÇ
        <br/>
        <br/>
        Êú¨ÁΩëÁ´ô ÊâÄÁªôÂá∫ÁöÑ‰ø°ÊÅØÂùáÊù•Ëá™ÂÖ¨ÂºÄÂèØÂæóÁöÑ‰ø°ÊÅØÊù•Ê∫êÔºå‰∏ç‰øùËØÅÂÖ∂ÂáÜÁ°ÆÊÄß„ÄÅÂÆåÊï¥ÊÄß„ÄÅÂÆûÊó∂ÊÄßÊàñÈÄÇÁî®ÊÄß„ÄÇ
        <br/>
        <br/>
        Áî±‰∫é Êú¨ÁΩëÁ´ô Êó†Ê≥ïÊéßÂà∂Áî®Êà∑ÁöÑËæìÂÖ•ÂíåÊìç‰ΩúÔºåÂõ†Ê≠§‰ΩøÁî®Êú¨Â∑•ÂÖ∑ËøáÁ®ã‰∏≠‰∫ßÁîüÁöÑ‰ªª‰ΩïÂêéÊûúÂùáÁî±Áî®Êà∑‰∏™‰∫∫ÊâøÊãÖ„ÄÇ
        <br/>
        <br/>
        Êú¨ÁΩëÁ´ô ‰∏çÊâøÊãÖ‰ªª‰ΩïÂõ†‰ø°ÊÅØËé∑Âèñ„ÄÅ‰ΩøÁî®Êàñ‰æùËµñ Êú¨ÁΩëÁ´ô ÊâÄÊèê‰æõÁöÑ‰ø°ÊÅØËÄå‰∫ßÁîüÁöÑ‰ªª‰ΩïÁõ¥Êé•„ÄÅÈó¥Êé•„ÄÅÂÅ∂ÁÑ∂„ÄÅÁâπÊÆä„ÄÅË°çÁîü„ÄÅÊÉ©ÁΩöÊÄßÊàñÂõ†ËøùÁ∫¶ËÄå‰∫ßÁîüÁöÑÊçüÂ§±„ÄÇ
        <br/>
        <br/>
        Êú¨ÁΩëÁ´ô ‰øùÁïôÊùÉÂà©ÈöèÊó∂Êõ¥ÊîπÊú¨ÂÖçË¥£Â£∞Êòé„ÄÇËØ∑Âú®‰ΩøÁî®ÂâçÂÆöÊúüÊ£ÄÊü•‰ª•Ëé∑ÂèñÊúÄÊñ∞Êõ¥Êñ∞ÁöÑÁâàÊùÉÂ£∞Êòé„ÄÇ
        <br/>
        <br/>
        Âú®ÊÇ®ÂºÄÂßã‰ΩøÁî® Êú¨ÁΩëÁ´ô ‰πãÂâçÔºåËØ∑Á°Æ‰øùÊÇ®Â∑≤ÂÆåÂÖ®ÁêÜËß£‰ª•‰∏äÊâÄÊúâÊù°Ê¨æÔºåÂπ∂Êé•ÂèóÂÖ∂‰∏≠ÁöÑÊâÄÊúâÊù°Ê¨æ„ÄÇÂ¶ÇÊûúÊÇ®ÂØπÊú¨ÂÖçË¥£Â£∞ÊòéÊúâ‰ªª‰ΩïÁñëÈóÆÔºåËØ∑Âãø‰ΩøÁî®ËØ•ÊúçÂä°„ÄÇ
        <br/>
        <br/>
        ÊúÄÂêéÔºåÂ¶ÇÊûú‰ΩøÁî®Êúâ‰ªÄ‰πàÈóÆÈ¢òÔºåÈÇ£Â∞±ÊòØÊïÖÊÑèÁöÑ(doge).
      </Modal>

      <Modal title="ÊèêÁ§∫" open={isModalOpenKey} onOk={handleOkKey} onCancel={handleCancelKey}>
        <p>ËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëòËé∑ÂèñÊñ∞ÁöÑkeyËØ∑Â¶•ÂñÑ‰øùÂ≠òÔºåkeyÊòØÊÇ®‰ΩøÁî®Êú¨ÁΩëÁ´ôÁöÑÂîØ‰∏ÄÂØπËØùÂá≠ËØÅÔºÅ</p>
        <p>
          <img style={{width: 423, height: 300}}
               src="/dog.gif" alt=""/>
        </p>
        <p>
          <Input
            value={newKey}
            onChange={(e) => setNewKey(e.target.value)}
            placeholder='ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊñ∞KEY'
          />
        </p>
      </Modal>
    </div>

  );
};

export default App;
